<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      --bg-color: #FFFFFF;
      --font-color: #333333;
      --primary-color: #0D99FF;
      --primary-hover: #0B7DD9;
      --secondary-bg: #F0F0F0;
      --border-color: #E5E5E5;
      --error-color: #F24822;
      --success-color: #1BC47D;
      --info-color: #e0e0e0;
      --info-font-color: #555;
      --revisado-bg: #F5F5F5;
      --revisado-border: #DDDDDD;
      --reemplazado-bg: #E4F8E5;
      --reemplazado-border: #A3D9A5;
      --omitido-bg: #EEEEEE;
    }
    body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--font-color); margin: 0; padding: 16px; font-size: 12px;}
    .container { display: flex; flex-direction: column; gap: 12px; }
    h3 { margin: 0; font-size: 14px; font-weight: 600; text-align: center; }
    .rules-group, .results-group { background-color: var(--secondary-bg); border-radius: 8px; padding: 12px; text-align: left; }
    label { font-size: 11px; font-weight: 500; display: block; margin-bottom: 4px; }
    textarea, .replace-input { width: 100%; box-sizing: border-box; border-radius: 6px; border: 1px solid var(--border-color); padding: 8px; font-family: var(--font-family); font-size: 12px; }
    button { font-weight: 600; font-size: 12px; padding: 10px; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.2s; width: 100%;}
    #revisar-seleccion, #revisar-todo { margin-bottom: 8px; }
    button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
    #status-box { padding: 12px; font-weight: 600; border-radius: 8px; text-align: center; }
    .status.success { background-color: var(--success-color); color: white; }
    .status.error { background-color: var(--error-color); color: white; }
    .status.info { background-color: var(--info-color); color: var(--info-font-color); }
    #results-list { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .result-item { background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); transition: background-color 0.2s; }
    .result-item-content { cursor: pointer; }
    .error-term { color: var(--error-color); font-weight: bold; }
    .location { font-size: 10px; color: #666; }
    .text-preview { font-style: italic; color: #333; margin-bottom: 8px; }
    .result-item.revisado { background-color: var(--revisado-bg); border-color: var(--revisado-border); }
    .result-item.reemplazado { background-color: var(--reemplazado-bg); border-color: var(--reemplazado-border); opacity: 0.8; }
    .result-item.omitido { background-color: var(--omitido-bg); opacity: 0.7; }
    .result-item.omitido .result-item-content { text-decoration: line-through; }
    .action-bar { margin-top: 10px; display: flex; gap: 8px; align-items: center; }
    .replace-btn { background-color: var(--primary-color); color: white; padding: 6px 10px; font-size: 11px; width: auto; flex-grow: 1; }
    .replace-btn:hover { background-color: var(--primary-hover); }
    .skip-btn { background-color: #888; color: white; padding: 6px 10px; font-size: 11px; width: auto; }
    .skip-btn:hover { background-color: #666; }
    #clear-memory { background: none; color: #888; font-size: 10px; padding: 4px; text-decoration: underline; width: auto; margin: 8px auto 0 auto; display: block; }
  </style>
</head>
<body>
  <div class="container">
    <h3>Asistente de Contenido</h3>
    <div class="rules-group">
      <label for="prohibidos">T√©rminos a buscar (separados por coma)</label>
      <textarea id="prohibidos"></textarea>
    </div>

    <button id="revisar-seleccion">Revisar Selecci√≥n</button>
    <button id="revisar-todo">Revisar Todo Autom√°ticamente</button>
    
    <div id="status-box" class="status info">Listo para revisar.</div>

    <div class="results-group">
      <label>Resultados encontrados:</label>
      <div id="results-list"></div>
    </div>
    
    <button id="clear-memory">Limpiar memoria de este archivo</button>
  </div>

  <script>
    const prohibidosInput = document.getElementById('prohibidos');
    const revisarSeleccionBtn = document.getElementById('revisar-seleccion');
    const revisarTodoBtn = document.getElementById('revisar-todo');
    const statusBox = document.getElementById('status-box');
    const resultsList = document.getElementById('results-list');
    const clearMemoryBtn = document.getElementById('clear-memory');

    revisarSeleccionBtn.onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'revisar-seleccion', prohibidos: prohibidosInput.value } }, '*');
    };

    revisarTodoBtn.onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'revisar-todo', prohibidos: prohibidosInput.value } }, '*');
    };
    
    clearMemoryBtn.onclick = () => {
      if (confirm('¬øEst√°s seguro? Se borrar√°n todas las decisiones de "omitir" y "reemplazar" guardadas para este archivo.')) {
        parent.postMessage({ pluginMessage: { type: 'limpiar-memoria' } }, '*');
      }
    };

    resultsList.onclick = (event) => {
      const target = event.target;
      const resultItem = target.closest('.result-item');
      if (!resultItem) return;

      const nodeId = resultItem.dataset.nodeId;
      const termino = resultItem.dataset.errorTerm;

      if (target.classList.contains('replace-btn')) {
        const input = resultItem.querySelector('.replace-input');
        const nuevoTermino = input.value;
        if (!nuevoTermino) return;
        parent.postMessage({ pluginMessage: { type: 'reemplazar-texto', nodeId, terminoAntiguo: termino, terminoNuevo: nuevoTermino }}, '*');
      }
      else if (target.classList.contains('skip-btn')) {
        parent.postMessage({ pluginMessage: { type: 'omitir-error', nodeId, termino }}, '*');
      }
      else if (target.closest('.result-item-content')) {
        resultItem.classList.add('revisado');
        parent.postMessage({ pluginMessage: { type: 'ir-a-nodo', nodeId }}, '*');
      }
    };

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      switch (msg.type) {
        case 'scan-iniciado':
          revisarSeleccionBtn.disabled = true;
          revisarTodoBtn.disabled = true;
          resultsList.innerHTML = '';
          statusBox.className = 'status info';
          statusBox.innerText = 'Buscando (cargando memoria)...';
          break;
        case 'scan-finalizado':
          revisarSeleccionBtn.disabled = false;
          revisarTodoBtn.disabled = false;
          statusBox.className = 'status ' + (msg.errores.length > 0 ? 'info' : 'success');
          statusBox.innerHTML = `B√∫squeda completa. Se encontraron ${msg.errores.length} nuevas coincidencias.`;
          resultsList.innerHTML = ''; 
          msg.errores.forEach(err => {
            const item = document.createElement('div');
            item.className = 'result-item';
            item.dataset.nodeId = err.nodeId;
            item.dataset.errorTerm = err.error;
            item.innerHTML = `
              <div class="result-item-content">
                <div class="location">üìç En: <b>${err.ubicacion}</b></div>
                <div class="text-preview">"...${err.texto}..."</div>
                <div>T√©rmino encontrado: <span class="error-term">${err.error}</span></div>
              </div>
              <div class="action-bar">
                <input type="text" class="replace-input" placeholder="Reemplazar por...">
                <button class="replace-btn">Reemplazar</button>
                <button class="skip-btn">Omitir</button>
              </div>
            `;
            resultsList.appendChild(item);
          });
          break;
        case 'decision-guardada':
          const item = resultsList.querySelector(`[data-node-id="${msg.nodeId}"][data-error-term="${msg.termino}"]`);
          if (item) {
            item.classList.remove('revisado');
            if (msg.decision === 'reemplazado') {
              item.classList.add('reemplazado');
              item.querySelector('.action-bar').innerHTML = `‚úÖ Reemplazado por "<b>${msg.terminoNuevo}</b>"`;
            } else if (msg.decision === 'omitido') {
              item.classList.add('omitido');
              item.querySelector('.action-bar').innerHTML = '‚ö™Ô∏è Omitido y guardado en memoria.';
            }
          }
          break;
        case 'memoria-limpiada':
          statusBox.className = 'status success';
          statusBox.innerHTML = '¬°Memoria limpiada! La pr√≥xima b√∫squeda ser√° desde cero.';
          setTimeout(() => {
            statusBox.className = 'status info';
            statusBox.innerHTML = 'Listo para revisar.';
          }, 2500);
          break;
      }
    };
  </script>
</body>
</html>